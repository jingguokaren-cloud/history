<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>éƒ­æ­£ä¸­ä¸“å±å†å²å¤ä¹ ç½‘é¡µ</title>
    <meta name="description" content="é«˜ä¸­å†å²Flashcardå¤ä¹ ç³»ç»Ÿ - ä¸­å¤–å†å²çº²è¦">
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary-brown: #5D4037;
            --primary-gold: #FFB300;
            --primary-gradient: linear-gradient(135deg, #5D4037 0%, #8D6E63 50%, #FFB300 100%);
            --card-front: linear-gradient(145deg, #FFFDE7 0%, #FFF8E1 100%);
            --card-back: linear-gradient(145deg, #FFF3E0 0%, #FFE0B2 100%);
            --text-dark: #3E2723;
            --text-light: #EFEBE9;
            --shadow-soft: 0 10px 40px rgba(93, 64, 55, 0.2);
            --shadow-card: 0 15px 35px rgba(93, 64, 55, 0.25);
            --bg-main: linear-gradient(180deg, #EFEBE9 0%, #D7CCC8 100%);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--bg-main);
            min-height: 100vh;
            color: var(--text-dark);
        }

        /* ========== æ¬¢è¿ç•Œé¢ ========== */
        .welcome-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: var(--primary-gradient);
            animation: gradientShift 15s ease infinite;
            background-size: 200% 200%;
        }

        @keyframes gradientShift {

            0%,
            100% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }
        }

        .welcome-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 2.8rem;
            color: #FFF;
            text-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3);
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: rgba(255, 255, 255, 0.9);
            margin-bottom: 2rem;
        }

        .stats-container {
            display: flex;
            gap: 2rem;
            margin-bottom: 3rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            text-align: center;
            color: #FFF;
            min-width: 120px;
            transition: transform 0.3s, background 0.3s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(255, 255, 255, 0.25);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            display: block;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .textbook-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            max-width: 900px;
            width: 100%;
        }

        .textbook-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: var(--shadow-soft);
        }

        .textbook-card:hover:not(.coming-soon) {
            transform: translateY(-8px) scale(1.02);
            box-shadow: var(--shadow-card);
        }

        .textbook-card.coming-soon {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .textbook-card .icon {
            font-size: 2.5rem;
            margin-bottom: 0.5rem;
        }

        .textbook-card .name {
            font-weight: 600;
            color: var(--primary-brown);
            font-size: 1.1rem;
        }

        .textbook-card .status {
            font-size: 0.85rem;
            color: #888;
            margin-top: 0.3rem;
        }

        .textbook-card.active .status {
            color: var(--primary-gold);
            font-weight: 500;
        }

        /* ========== ä¸»å­¦ä¹ ç•Œé¢ ========== */
        .study-screen {
            display: none;
            min-height: 100vh;
            padding: 1rem;
        }

        .study-screen.active {
            display: block;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .back-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(93, 64, 55, 0.1);
        }

        .header-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3rem;
            color: var(--primary-brown);
        }

        .progress-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .progress-text {
            font-size: 0.9rem;
            color: #666;
        }

        .progress-bar {
            width: 120px;
            height: 8px;
            background: #E0E0E0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: var(--primary-gradient);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        /* ========== å•å…ƒé€‰æ‹© ========== */
        .unit-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            overflow-x: auto;
            padding-bottom: 0.5rem;
        }

        .unit-btn {
            padding: 0.8rem 1.2rem;
            border: 2px solid var(--primary-brown);
            background: transparent;
            border-radius: 25px;
            cursor: pointer;
            font-size: 0.9rem;
            white-space: nowrap;
            transition: all 0.3s;
            color: var(--primary-brown);
        }

        .unit-btn:hover,
        .unit-btn.active {
            background: var(--primary-brown);
            color: #FFF;
        }

        /* ========== å¡ç‰‡åŒºåŸŸ ========== */
        .card-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 500px;
            margin-bottom: 1.5rem;
        }

        .flashcard {
            width: 100%;
            max-width: 700px;
            min-height: 450px;
            background: var(--card-front);
            border-radius: 24px;
            padding: 2rem;
            box-shadow: var(--shadow-card);
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px dashed rgba(93, 64, 55, 0.2);
        }

        .card-number {
            font-size: 0.9rem;
            color: rgba(93, 64, 55, 0.6);
            font-weight: 500;
        }

        .question-type {
            padding: 0.4rem 1rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .question-type.subjective {
            background: #E3F2FD;
            color: #1565C0;
        }

        .question-type.objective {
            background: #E8F5E9;
            color: #2E7D32;
        }

        .favorite-btn {
            font-size: 1.5rem;
            background: none;
            border: none;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .favorite-btn:hover {
            transform: scale(1.2);
        }

        .favorite-btn.active {
            animation: heartBeat 0.5s;
        }

        @keyframes heartBeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        .card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .question-section {
            background: rgba(255, 255, 255, 0.6);
            padding: 1.5rem;
            border-radius: 16px;
            border-left: 4px solid var(--primary-brown);
        }

        .question-label {
            font-size: 0.85rem;
            color: rgba(93, 64, 55, 0.6);
            margin-bottom: 0.5rem;
        }

        .card-question {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.3rem;
            color: var(--primary-brown);
            line-height: 1.8;
        }

        .blank {
            display: inline-block;
            min-width: 80px;
            padding: 0.2rem 0.6rem;
            margin: 0 0.2rem;
            background: #95b3ee;
            color: transparent;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            user-select: none;
            font-weight: 600;
        }

        .blank:hover {
            background: #5D4037;
            transform: scale(1.05);
        }

        .blank.revealed {
            background: #E8F5E9;
            color: #2E7D32;
            border: 2px solid #4CAF50;
        }

        .blank.partial {
            background: #FFF3E0;
            color: #E65100;
            border: 2px solid #FF9800;
        }

        .answer-section {
            background: rgba(255, 243, 224, 0.5);
            padding: 1.5rem;
            border-radius: 16px;
            border-left: 4px solid var(--primary-gold);
        }

        .answer-label {
            font-size: 0.85rem;
            color: rgba(93, 64, 55, 0.6);
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .answer-content {
            font-size: 1rem;
            line-height: 2;
            color: var(--text-dark);
        }

        .answer-content strong {
            color: var(--primary-brown);
        }

        .card-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px dashed rgba(93, 64, 55, 0.2);
        }

        .action-btn {
            flex: 1;
            padding: 0.8rem 1rem;
            border: none;
            border-radius: 12px;
            font-size: 0.95rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-show-all {
            background: var(--primary-brown);
            color: #FFF;
        }

        .btn-show-all:hover {
            background: #4E342E;
            transform: translateY(-2px);
        }

        .btn-hide-all {
            background: #78909C;
            color: #FFF;
        }

        .btn-hide-all:hover {
            background: #546E7A;
            transform: translateY(-2px);
        }

        .hint-text {
            text-align: center;
            color: rgba(93, 64, 55, 0.5);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }

        /* ç­”æ¡ˆå±•å¼€/æŠ˜å  */
        .answer-wrapper {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .answer-toggle {
            padding: 1rem 1.5rem;
            background: linear-gradient(135deg, #5D4037 0%, #8D6E63 100%);
            color: #FFF;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 500;
            transition: all 0.3s;
        }

        .answer-toggle:hover {
            background: linear-gradient(135deg, #4E342E 0%, #6D4C41 100%);
        }

        .toggle-icon {
            transition: transform 0.3s;
        }

        .answer-wrapper.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .answer-details {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease;
        }

        .answer-wrapper.expanded .answer-details {
            max-height: 2000px;
        }

        .answer-wrapper .answer-section {
            margin: 1rem;
        }

        .answer-wrapper .answer-section:first-child {
            margin-top: 1.5rem;
        }

        .answer-wrapper .answer-section:last-child {
            margin-bottom: 1.5rem;
        }

        .source-section .answer-content {
            border-left: 4px solid #FFB300;
            background: rgba(255, 179, 0, 0.1);
            padding: 1rem;
            border-radius: 0 12px 12px 0;
        }

        .memory-section .answer-content {
            border-left: 4px solid #4CAF50;
            background: rgba(76, 175, 80, 0.1);
            padding: 1rem;
            border-radius: 0 12px 12px 0;
        }

        /* ========== æ§åˆ¶æŒ‰é’® ========== */
        .controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
            font-weight: 500;
        }

        .btn-prev,
        .btn-next {
            background: var(--primary-brown);
            color: #FFF;
        }

        .btn-prev:hover,
        .btn-next:hover {
            background: #4E342E;
            transform: translateY(-2px);
        }

        .btn-random {
            background: var(--primary-gold);
            color: var(--text-dark);
        }

        .btn-random:hover {
            background: #FFA000;
            transform: translateY(-2px);
        }

        .btn-check {
            background: #4CAF50;
            color: #FFF;
        }

        .btn-check:hover {
            background: #388E3C;
            transform: translateY(-2px);
        }

        /* ========== è®°å¿†æŠ€å·§é¢æ¿ ========== */
        .memory-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 1.5rem;
            margin-top: 1.5rem;
            box-shadow: var(--shadow-soft);
        }

        .panel-title {
            font-family: 'Noto Serif SC', serif;
            font-size: 1.2rem;
            color: var(--primary-brown);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .memory-methods {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .method-card {
            background: linear-gradient(145deg, #FFF 0%, #F5F5F5 100%);
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .method-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-soft);
        }

        .method-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .method-name {
            font-weight: 600;
            color: var(--primary-brown);
            margin-bottom: 0.3rem;
        }

        .method-desc {
            font-size: 0.85rem;
            color: #666;
        }

        /* ========== å“åº”å¼è®¾è®¡ ========== */
        @media (max-width: 768px) {
            .welcome-title {
                font-size: 2rem;
            }

            .stats-container {
                gap: 1rem;
            }

            .stat-card {
                padding: 1rem 1.5rem;
                min-width: 100px;
            }

            .stat-number {
                font-size: 2rem;
            }

            .header {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }

            .card-question {
                font-size: 1.4rem;
            }

            .controls {
                flex-direction: column;
            }

            .control-btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* ========== æ‰“å¡åŠ¨ç”» ========== */
        .check-animation {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5rem;
            z-index: 1000;
            animation: checkPop 1s ease forwards;
            pointer-events: none;
        }

        @keyframes checkPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 1;
            }

            50% {
                transform: translate(-50%, -50%) scale(1.2);
                opacity: 1;
            }

            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 0;
            }
        }

        /* ========== Toast æç¤º ========== */
        .toast {
            position: fixed;
            bottom: 2rem;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: rgba(62, 39, 35, 0.9);
            color: #FFF;
            padding: 1rem 2rem;
            border-radius: 12px;
            opacity: 0;
            transition: all 0.3s;
            z-index: 1000;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }
    </style>
</head>

<body>
    <!-- æ¬¢è¿ç•Œé¢ -->
    <div class="welcome-screen" id="welcomeScreen">
        <h1 class="welcome-title">ğŸ“ éƒ­æ­£ä¸­ä¸“å±å†å²å¤ä¹ ç½‘é¡µ</h1>
        <p class="welcome-subtitle">é«˜ä¸­å†å² Flashcard å¤ä¹ ç³»ç»Ÿ</p>

        <div class="stats-container">
            <div class="stat-card">
                <span class="stat-number" id="totalCards">0</span>
                <span class="stat-label">çŸ¥è¯†å¡ç‰‡</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="learnedCards">0</span>
                <span class="stat-label">å·²å­¦ä¹ </span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="favoriteCards">0</span>
                <span class="stat-label">æ”¶è—</span>
            </div>
            <div class="stat-card">
                <span class="stat-number" id="streakDays">0</span>
                <span class="stat-label">è¿ç»­æ‰“å¡</span>
            </div>
        </div>

        <div class="textbook-grid" id="textbookGrid">
            <!-- æ•™æå¡ç‰‡ç”±JSç”Ÿæˆ -->
        </div>
    </div>

    <!-- å­¦ä¹ ç•Œé¢ -->
    <div class="study-screen" id="studyScreen">
        <header class="header">
            <button class="back-btn" id="backBtn">â¬…ï¸</button>
            <h2 class="header-title" id="headerTitle">ä¸­å¤–å†å²çº²è¦ï¼ˆä¸‹ï¼‰</h2>
            <div class="progress-info">
                <span class="progress-text" id="progressText">1 / 10</span>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 10%"></div>
                </div>
            </div>
        </header>

        <div class="unit-selector" id="unitSelector">
            <!-- å•å…ƒæŒ‰é’®ç”±JSç”Ÿæˆ -->
        </div>

        <div class="card-container">
            <div class="flashcard" id="flashcard">
                <div class="card-header">
                    <span class="card-number" id="cardNumber">ç¬¬ 1 é¢˜</span>
                    <span class="question-type objective" id="questionType">å®¢è§‚é¢˜</span>
                    <button class="favorite-btn" id="favoriteBtn">ğŸ¤</button>
                </div>

                <div class="card-content">
                    <div class="question-section">
                        <div class="question-label">ğŸ“ é¢˜ç›®ï¼ˆç‚¹å‡»é»‘è‰²æ–¹å—æŸ¥çœ‹ç­”æ¡ˆï¼‰</div>
                        <p class="card-question" id="cardQuestion">äººç±»æ–‡æ˜äº§ç”Ÿçš„æ ‡å¿—æ˜¯ä»€ä¹ˆï¼Ÿ</p>
                    </div>

                    <!-- ç­”æ¡ˆå±•å¼€åŒºåŸŸ -->
                    <div class="answer-wrapper collapsed" id="answerWrapper">
                        <div class="answer-toggle" id="answerToggle">
                            <span>ğŸ‘ï¸ æŸ¥çœ‹å®Œæ•´ç­”æ¡ˆ</span>
                            <span class="toggle-icon">â–¼</span>
                        </div>
                        
                        <div class="answer-details" id="answerDetails">
                            <div class="answer-section">
                                <div class="answer-label">ğŸ’¡ å®Œæ•´ç­”æ¡ˆ</div>
                                <div class="answer-content" id="answerContent"></div>
                            </div>

                            <div class="answer-section source-section" id="sourceSection">
                                <div class="answer-label">ğŸ“œ å²æ–™æ‹“å±•</div>
                                <div class="answer-content" id="sourceContent"></div>
                            </div>

                            <div class="answer-section memory-section" id="memorySection">
                                <div class="answer-label">ğŸ§  è®°å¿†æŠ€å·§</div>
                                <div class="answer-content" id="memoryContent"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card-actions">
                    <button class="action-btn btn-show-all" id="showAllBtn">ğŸ‘ï¸ æ˜¾ç¤ºæ‰€æœ‰æŒ–ç©º</button>
                    <button class="action-btn btn-hide-all" id="hideAllBtn">ğŸ”„ é‡ç½®æŒ–ç©º</button>
                </div>

                <p class="hint-text">ğŸ’¡ æç¤ºï¼šå…ˆå›å¿†ç­”æ¡ˆï¼Œå†ç‚¹å‡»ã€ŒæŸ¥çœ‹å®Œæ•´ç­”æ¡ˆã€æ ¸å¯¹</p>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn btn-prev" id="prevBtn">â¬…ï¸ ä¸Šä¸€é¢˜</button>
            <button class="control-btn btn-random" id="randomBtn">ğŸ² éšæœºæŠ½å¡</button>
            <button class="control-btn btn-check" id="checkBtn">âœ… æ‰“å¡å®Œæˆ</button>
            <button class="control-btn btn-next" id="nextBtn">ä¸‹ä¸€é¢˜ â¡ï¸</button>
        </div>


    </div>

    <div class="toast" id="toast"></div>

    <script src="history_data.js"></script>
    <script>
        // ========== çŠ¶æ€ç®¡ç† ==========
        const state = {
            currentTextbook: null,
            currentUnit: 0,
            currentCardIndex: 0,
            favorites: JSON.parse(localStorage.getItem('history_favorites') || '[]'),
            learned: JSON.parse(localStorage.getItem('history_learned') || '[]'),
            streakDays: parseInt(localStorage.getItem('history_streak') || '0'),
            lastStudyDate: localStorage.getItem('history_last_date') || ''
        };

        // ========== DOM å…ƒç´  ==========
        const welcomeScreen = document.getElementById('welcomeScreen');
        const studyScreen = document.getElementById('studyScreen');
        const textbookGrid = document.getElementById('textbookGrid');
        const flashcard = document.getElementById('flashcard');
        const unitSelector = document.getElementById('unitSelector');

        // ========== åˆå§‹åŒ– ==========
        function init() {
            checkStreak();
            renderTextbooks();
            updateStats();
            bindEvents();
        }

        // æ£€æŸ¥è¿ç»­æ‰“å¡
        function checkStreak() {
            const today = new Date().toDateString();
            const yesterday = new Date(Date.now() - 86400000).toDateString();

            if (state.lastStudyDate === today) {
                // ä»Šå¤©å·²æ‰“å¡
            } else if (state.lastStudyDate === yesterday) {
                // æ˜¨å¤©æ‰“å¡äº†ï¼Œç»§ç»­è¿ç»­
            } else if (state.lastStudyDate !== '') {
                // æ–­ç­¾äº†
                state.streakDays = 0;
                localStorage.setItem('history_streak', '0');
            }
        }

        // æ¸²æŸ“æ•™æé€‰æ‹©
        function renderTextbooks() {
            textbookGrid.innerHTML = historyData.textbooks.map(book => `
        <div class="textbook-card ${book.status === 'coming' ? 'coming-soon' : 'active'}" 
             data-id="${book.id}" 
             ${book.status === 'coming' ? '' : 'onclick="enterTextbook(\'' + book.id + '\')"'}>
          <div class="icon">${book.status === 'active' ? 'ğŸ“š' : 'ğŸ”’'}</div>
          <div class="name">${book.name}</div>
          <div class="status">${book.status === 'active' ? 'ç‚¹å‡»è¿›å…¥å­¦ä¹ ' : 'éœ€è¦è§£é”ï¼Œè¯·è”ç³» 14754898510'}</div>
        </div>
      `).join('');
        }

        // æ›´æ–°ç»Ÿè®¡
        function updateStats() {
            let totalCards = 0;
            if (historyData.world_history_2) {
                historyData.world_history_2.units.forEach(unit => {
                    totalCards += unit.cards.length;
                });
            }

            document.getElementById('totalCards').textContent = totalCards;
            document.getElementById('learnedCards').textContent = state.learned.length;
            document.getElementById('favoriteCards').textContent = state.favorites.length;
            document.getElementById('streakDays').textContent = state.streakDays;
        }

        // è¿›å…¥æ•™æ
        function enterTextbook(textbookId) {
            state.currentTextbook = textbookId;
            welcomeScreen.style.display = 'none';
            studyScreen.classList.add('active');

            renderUnits();
            selectUnit(0);
        }

        // æ¸²æŸ“å•å…ƒæŒ‰é’®
        function renderUnits() {
            const textbook = historyData[state.currentTextbook];
            unitSelector.innerHTML = textbook.units.map((unit, index) => `
        <button class="unit-btn ${index === 0 ? 'active' : ''}" onclick="selectUnit(${index})">
          ${unit.name}
        </button>
      `).join('');
        }

        // é€‰æ‹©å•å…ƒ
        function selectUnit(unitIndex) {
            state.currentUnit = unitIndex;
            state.currentCardIndex = 0;

            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.unit-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === unitIndex);
            });

            renderCard();
        }

        // è·å–å½“å‰å¡ç‰‡
        function getCurrentCards() {
            const textbook = historyData[state.currentTextbook];
            return textbook.units[state.currentUnit].cards;
        }

        // æ¸²æŸ“å¡ç‰‡
        function renderCard() {
            const cards = getCurrentCards();
            const card = cards[state.currentCardIndex];

            // æ›´æ–°é¢˜å·
            document.getElementById('cardNumber').textContent = `ç¬¬ ${state.currentCardIndex + 1} é¢˜`;

            // æ›´æ–°é¢˜å‹æ ‡ç­¾
            const typeEl = document.getElementById('questionType');
            if (card.type === 'subjective') {
                typeEl.textContent = 'ä¸»è§‚é¢˜';
                typeEl.className = 'question-type subjective';
            } else {
                typeEl.textContent = 'å®¢è§‚é¢˜';
                typeEl.className = 'question-type objective';
            }

            // æ¸²æŸ“å¸¦æŒ–ç©ºçš„é—®é¢˜
            const questionEl = document.getElementById('cardQuestion');
            if (card.blanks && card.blanks.length > 0) {
                let questionHtml = card.question;
                card.blanks.forEach((blank, index) => {
                    questionHtml = questionHtml.replace(
                        `{{${blank}}}`,
                        `<span class="blank" data-answer="${blank}" data-index="${index}">${blank}</span>`
                    );
                });
                questionEl.innerHTML = questionHtml;
            } else {
                questionEl.innerHTML = card.question;
            }

            // æ›´æ–°ç­”æ¡ˆå†…å®¹ï¼ˆå…ˆéšè—ï¼‰
            document.getElementById('answerContent').innerHTML = card.answer || '';
            document.getElementById('sourceContent').innerHTML = card.source || 'æš‚æ— ç›¸å…³å²æ–™';
            document.getElementById('memoryContent').innerHTML = card.memory || 'æš‚æ— è®°å¿†æŠ€å·§';

            // æ§åˆ¶å²æ–™å’Œè®°å¿†æŠ€å·§åŒºåŸŸçš„æ˜¾ç¤º
            const sourceSection = document.getElementById('sourceSection');
            const memorySection = document.getElementById('memorySection');
            sourceSection.style.display = card.source ? 'block' : 'none';
            memorySection.style.display = card.memory ? 'block' : 'none';

            // é‡ç½®ç­”æ¡ˆå±•å¼€çŠ¶æ€
            const answerWrapper = document.getElementById('answerWrapper');
            answerWrapper.classList.remove('expanded');
            answerWrapper.classList.add('collapsed');

            // ç»‘å®šæŒ–ç©ºç‚¹å‡»äº‹ä»¶
            bindBlankEvents();

            // æ›´æ–°æ”¶è—çŠ¶æ€
            const isFavorite = state.favorites.includes(`${state.currentTextbook}-${state.currentUnit}-${card.id}`);
            updateFavoriteBtn(isFavorite);

            // æ›´æ–°è¿›åº¦
            updateProgress();
        }

        // åˆ‡æ¢ç­”æ¡ˆå±•å¼€/æŠ˜å 
        function toggleAnswer() {
            const wrapper = document.getElementById('answerWrapper');
            wrapper.classList.toggle('expanded');
            wrapper.classList.toggle('collapsed');
            
            // å±•å¼€æ—¶è‡ªåŠ¨æ˜¾ç¤ºæ‰€æœ‰æŒ–ç©º
            if (wrapper.classList.contains('expanded')) {
                showAllAnswers();
            }
        }

        // è‡ªåŠ¨ç”ŸæˆæŒ–ç©º
        function autoGenerateBlanks(question, answer) {
            // ä»ç­”æ¡ˆä¸­æå–å…³é”®è¯ä½œä¸ºæŒ–ç©º
            const keywords = extractKeywords(answer);
            let result = question;

            keywords.forEach((keyword, index) => {
                if (result.includes(keyword) && index < 3) { // æœ€å¤š3ä¸ªæŒ–ç©º
                    result = result.replace(
                        keyword,
                        `<span class="blank" data-answer="${keyword}" data-index="${index}">${keyword}</span>`
                    );
                }
            });

            return result;
        }

        // æå–å…³é”®è¯ï¼ˆä»ç­”æ¡ˆä¸­æå–é‡è¦è¯æ±‡ï¼‰
        function extractKeywords(answer) {
            // ç®€å•çš„å…³é”®è¯æå–ï¼šæ‰¾ä¹¦åå·ã€æ•°å­—ã€ç‰¹å®šè¯ç»„
            const keywords = [];

            // æå–ä¹¦åå·å†…å®¹
            const bookMatches = answer.match(/ã€Š([^ã€‹]+)ã€‹/g);
            if (bookMatches) {
                keywords.push(...bookMatches);
            }

            // æå–å¹´ä»½
            const yearMatches = answer.match(/å‰?\d{3,4}å¹´/g);
            if (yearMatches) {
                keywords.push(...yearMatches.slice(0, 2));
            }

            // æå–äººåï¼ˆå¸¸è§å†å²äººç‰©ï¼‰
            const nameMatches = answer.match(/[\u4e00-\u9fa5]{2,4}(?=æ”¹é©|å¸å›½|æ—¶ä»£|æ—¶æœŸ)/g);
            if (nameMatches) {
                keywords.push(...nameMatches.slice(0, 2));
            }

            return [...new Set(keywords)]; // å»é‡
        }

        // ç»‘å®šæŒ–ç©ºç‚¹å‡»äº‹ä»¶
        function bindBlankEvents() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.addEventListener('click', function(e) {
                    e.stopPropagation();
                    if (this.classList.contains('revealed')) {
                        this.classList.remove('revealed');
                        this.textContent = this.dataset.answer;
                    } else {
                        this.classList.add('revealed');
                    }
                });
            });
        }

        // æ›´æ–°è¿›åº¦
        function updateProgress() {
            const cards = getCurrentCards();
            const current = state.currentCardIndex + 1;
            const total = cards.length;

            document.getElementById('progressText').textContent = `${current} / ${total}`;
            document.getElementById('progressFill').style.width = `${(current / total) * 100}%`;
        }

        // æ›´æ–°æ”¶è—æŒ‰é’®
        function updateFavoriteBtn(isFavorite) {
            const btn = document.getElementById('favoriteBtn');
            btn.textContent = isFavorite ? 'â¤ï¸' : 'ğŸ¤';
            if (isFavorite) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        }

        // æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ
        function showAllAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.classList.add('revealed');
            });
        }

        // éšè—æ‰€æœ‰ç­”æ¡ˆï¼ˆé‡ç½®ï¼‰
        function hideAllAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.classList.remove('revealed');
            });
        }

        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ”¶è—æŒ‰é’®
            document.getElementById('favoriteBtn').addEventListener('click', toggleFavorite);

            // ä¸Šä¸€é¢˜
            document.getElementById('prevBtn').addEventListener('click', () => {
                const cards = getCurrentCards();
                if (state.currentCardIndex > 0) {
                    state.currentCardIndex--;
                    renderCard();
                }
            });

            // ä¸‹ä¸€é¢˜
            document.getElementById('nextBtn').addEventListener('click', () => {
                const cards = getCurrentCards();
                if (state.currentCardIndex < cards.length - 1) {
                    state.currentCardIndex++;
                    renderCard();
                    markAsLearned();
                }
            });

            // éšæœºæŠ½å¡
            document.getElementById('randomBtn').addEventListener('click', () => {
                const cards = getCurrentCards();
                state.currentCardIndex = Math.floor(Math.random() * cards.length);
                renderCard();
                showToast('ğŸ² éšæœºæŠ½å–æˆåŠŸï¼');
            });

            // æ‰“å¡å®Œæˆ
            document.getElementById('checkBtn').addEventListener('click', checkIn);

            // è¿”å›æŒ‰é’®
            document.getElementById('backBtn').addEventListener('click', () => {
                studyScreen.classList.remove('active');
                welcomeScreen.style.display = 'flex';
                updateStats();
            });

            // æ˜¾ç¤ºæ‰€æœ‰ç­”æ¡ˆ
            document.getElementById('showAllBtn').addEventListener('click', showAllAnswers);

            // é‡ç½®æŒ–ç©º
            document.getElementById('hideAllBtn').addEventListener('click', hideAllAnswers);

            // å±•å¼€/æŠ˜å ç­”æ¡ˆ
            document.getElementById('answerToggle').addEventListener('click', toggleAnswer);
        }

        // åˆ‡æ¢æ”¶è—
        function toggleFavorite(e) {
            e.stopPropagation();
            const cards = getCurrentCards();
            const card = cards[state.currentCardIndex];
            const cardKey = `${state.currentTextbook}-${state.currentUnit}-${card.id}`;

            const index = state.favorites.indexOf(cardKey);
            if (index === -1) {
                state.favorites.push(cardKey);
                showToast('â¤ï¸ å·²æ·»åŠ åˆ°æ”¶è—');
            } else {
                state.favorites.splice(index, 1);
                showToast('ğŸ’” å·²å–æ¶ˆæ”¶è—');
            }

            localStorage.setItem('history_favorites', JSON.stringify(state.favorites));
            updateFavoriteBtn(index === -1);
            updateStats();
        }

        // æ ‡è®°å·²å­¦ä¹ 
        function markAsLearned() {
            const cards = getCurrentCards();
            const card = cards[state.currentCardIndex];
            const cardKey = `${state.currentTextbook}-${state.currentUnit}-${card.id}`;

            if (!state.learned.includes(cardKey)) {
                state.learned.push(cardKey);
                localStorage.setItem('history_learned', JSON.stringify(state.learned));
            }
        }

        // æ‰“å¡
        function checkIn() {
            const today = new Date().toDateString();

            if (state.lastStudyDate !== today) {
                state.streakDays++;
                state.lastStudyDate = today;
                localStorage.setItem('history_streak', state.streakDays.toString());
                localStorage.setItem('history_last_date', today);
            }

            // æ˜¾ç¤ºåŠ¨ç”»
            const checkAnim = document.createElement('div');
            checkAnim.className = 'check-animation';
            checkAnim.textContent = 'âœ…';
            document.body.appendChild(checkAnim);

            setTimeout(() => checkAnim.remove(), 1000);

            showToast(`ğŸ‰ æ‰“å¡æˆåŠŸï¼å·²è¿ç»­ ${state.streakDays} å¤©`);
            updateStats();
        }

        // Toast æç¤º
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 2000);
        }

        // å¯åŠ¨
        init();
    </script>
</body>

</html>
